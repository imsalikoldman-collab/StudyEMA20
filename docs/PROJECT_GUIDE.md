# Руководство по проекту StudyEMA20

Этот документ дополняет `docs/README.md` подробными рекомендациями по сборке, развертыванию и устранению неполадок исследования StudyEMA20 для Sierra Chart.

## Назначение проекта
- Построение экспоненциальных скользящих средних с периодами 20 и 9 на основном ценовом графике.
- Отображение контрольного счётчика, который циклично обновляется и подтверждает, что обработка текущего бара продолжается.
- Набор скриптов, упрощающих сборку, проверку, развертывание и горячую замену DLL.

## Структура репозитория
- `StudyEMA20.sln`, `StudyEMA20.vcxproj` — файлы решения и проекта Visual Studio.
- `src/EMA20Study.cpp` — реализация исследования и вспомогательных функций.
- `scripts/` — инструменты PowerShell (`build.ps1`, `deploy.ps1`, `hotdeploy.ps1`, `verify.ps1`, `release.ps1`).
- `build/` — генерируемые бинарные файлы и промежуточные результаты (можно удалять, при следующей сборке создаются заново).
- `docs/` — документация (`README.md`, `PROJECT_GUIDE.md`).
- `examples/` — эталонные фрагменты кода: примеры оформления и корректного использования объектов и функций (см. `docs/EXAMPLES_USAGE.md` для описаний `@usage`).

## Требования к окружению
1. **Заголовки Sierra Chart ACS** — установите Sierra Chart и убедитесь, что SDK распакован в `C:\2308\ACS_Source\`. Этот путь прописан в проекте.
2. **Инструментарий** — Visual Studio 2022 с компилятором MSVC v143 (x64) и доступным MSBuild. Скрипты автоматически ищут `MSBuild.exe` через `vswhere`, PATH или `dotnet msbuild`.
3. **PowerShell** — версия 7 или новее (`pwsh.exe`). Скрипты настраивают консоль в UTF-8, что корректно работает в PowerShell 7.
4. **Опционально** — запущенный Sierra Chart с включённым удалённым управлением по UDP (`127.0.0.1:11099`) для автоматического развертывания.

## Сценарии сборки
- **Release (по умолчанию)**  
  ```powershell
  pwsh .\scripts\build.ps1
  ```
- **Debug**  
  ```powershell
  pwsh .\scripts\build.ps1 -Configuration Debug
  ```
- **Чистая сборка**  
  ```powershell
  pwsh .\scripts\build.ps1 -Clean
  ```

Готовые файлы появляются в каталоге `build\<Платформа>\<Конфигурация>`, например `build\x64\Release\StudyEMA20.dll`.

## Проверка
Для чистой сборки и базовых проверок используйте:
```powershell
pwsh .\scripts\verify.ps1
```
Скрипт выполняет clean build и убеждается, что расчёты EMA остаются в исходнике `src/EMA20Study.cpp`.

## Развертывание

### Стандартное развертывание
```powershell
pwsh .\scripts\deploy.ps1
```
- При необходимости отправляет команду `RELEASE_DLL--<путь>` в Sierra Chart.
- Ожидает освобождения целевого файла (если не указан `-SkipWait`).
- Копирует `StudyEMA20.dll` в каталог назначения (`C:\2308\Data\` по умолчанию).
- Поддерживает параметры `-Destination`, `-SierraHost`, `-SierraPort`, `-ReleaseCommandFormat`, `-DisableRelease`.

### Горячая замена (hot deploy)
```powershell
pwsh .\scripts\hotdeploy.ps1
```
- Создаёт временную копию DLL рядом с целью.
- Отправляет `RELEASE_DLL` до копирования (если не указан `-SkipCopy`).
- Ждёт освобождения старой DLL, копирует временный файл атомарно и удаляет его.
- Посылает `ALLOW_LOAD_DLL`, чтобы Sierra Chart загрузил обновление.
- Позволяет задавать каталог назначения, адрес/порт, форматы команд, таймауты ожидания и режим пропуска копирования.

### Быстрый сценарий
```powershell
pwsh .\scripts\release.ps1
```
Запускает релизную сборку и горячую замену последовательно. Флаги `-SkipBuild` и `-SkipHotDeploy` отключают соответствующие этапы.

## Настройка удалённого управления Sierra Chart
Чтобы скрипты могли отправлять команды (версия Sierra Chart 2308+):
1. Откройте `Global Settings -> General Settings -> Remote Settings (Remote Control)`.
2. Включите удалённое управление по UDP, укажите порт (по умолчанию `11099`) и разрешённый хост (`127.0.0.1` либо иной доверенный адрес).
3. Используйте двойной дефис в командах, например:  
   `RELEASE_DLL--C:\2308\Data\StudyEMA20.dll`  
   `ALLOW_LOAD_DLL--C:\2308\Data\StudyEMA20.dll`
4. Проверяйте подтверждения в *Message Log* (`Remote Control UDP Command Received: ...`).

Если команды не принимаются, убедитесь в корректности настроек удалённого управления, правил firewall и запуске Sierra Chart от имени текущего пользователя.

## Устранение неполадок
- **Отсутствуют заголовки ACS** — установите или обновите Sierra Chart, чтобы путь `C:\2308\ACS_Source\` существовал.
- **MSBuild не найден** — установите Visual Studio Build Tools либо добавьте MSBuild в PATH; допускается использование `dotnet msbuild`.
- **Файл заблокирован при копировании** — увеличьте `-WaitTimeoutSeconds` или выгрузите исследование вручную.
- **Команды hot deploy игнорируются** — проверьте порт, адрес и формат команд в настройках удалённого управления.
- **Устаревшие артефакты** — удалите каталог `build\`; следующая сборка создаст файлы заново.

При необходимости вернитесь к `docs/README.md` для краткой сводки.
